class CLI
  def login_user!
    puts "Input your email:"
    email = gets.chomp
    @current_user = User.find_or_create_by(email: email)
  end

  def get_user_choice
    while true
      puts "What do you want to do?"
      puts "0. Create shortened URL"
      puts "1. Visit shortened URL"

      choice = Integer(gets.chomp)
      break if [0, 1].include?(choice)
      puts "Invalid response"
    end

    choice
  end

  def create_url!
    puts "Type in your long url"
    long_url = gets.chomp

    shortened_url = ShortenedUrl.create_for_user_and_long_url!(@current_user, long_url)
    puts "Short url is: #{shortened_url.short_url}"
    puts "Goodbye!"
  end

  def visit_url!
    puts "Type in your shortened url"
    short_url = gets.chomp
    if ShortenedUrl.exists?(short_url: short_url)
      shortened_url = ShortenedUrl.where(short_url: short_url).first
      Visit.record_visit!(@current_user, shortened_url)
      Launchy.open(shortened_url.long_url)
    else
      puts "Invalid shortened url"
    end
  end

  def run
    login_user!

    case get_user_choice
    when 0
      create_url!
    when 1
      visit_url!
    end
  end
end

CLI.new.run
